#!/bin/bash

# Git Hook: Pre-commit
# Valida configura√ß√µes cr√≠ticas antes de permitir commits

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}üîç Executando valida√ß√µes de seguran√ßa...${NC}"

# Verificar se o workflow foi modificado
if git diff --cached --name-only | grep -q ".github/workflows/main.yml"; then
    echo -e "${YELLOW}‚ö†Ô∏è  Workflow de deploy foi modificado - executando valida√ß√£o cr√≠tica...${NC}"
    
    # Executar script de valida√ß√£o
    if [ -f "scripts/validate-workflow.sh" ]; then
        ./scripts/validate-workflow.sh
        if [ $? -ne 0 ]; then
            echo -e "${RED}‚ùå COMMIT BLOQUEADO: Configura√ß√µes de deploy inv√°lidas!${NC}"
            echo -e "${YELLOW}üí° Corrija os problemas acima antes de fazer commit.${NC}"
            exit 1
        fi
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Script de valida√ß√£o n√£o encontrado em scripts/validate-workflow.sh${NC}"
    fi
    
    echo -e "${GREEN}‚úÖ Valida√ß√£o de deploy aprovada!${NC}"
fi

# Executar checklist de pr√©-deploy quando houver mudan√ßas relevantes
CHANGED_FILES="$(git diff --cached --name-only)"
if echo "$CHANGED_FILES" | grep -E -q "^(src/|vite.config\\.ts|index\\.html|public/|\\.github/workflows/main\\.yml)"; then
    echo -e "${YELLOW}üìã Executando checklist de pr√©-deploy (build, .htaccess, assets)...${NC}"
    if [ -f "scripts/pre-deploy-check.sh" ]; then
        ./scripts/pre-deploy-check.sh
        if [ $? -ne 0 ]; then
            echo -e "${RED}‚ùå COMMIT BLOQUEADO: Checklist de pr√©-deploy falhou.${NC}"
            echo -e "${YELLOW}üí° Corrija os problemas acima antes de fazer commit.${NC}"
            exit 1
        fi
    else
        echo -e "${YELLOW}‚ö†Ô∏è  scripts/pre-deploy-check.sh n√£o encontrado; pulei valida√ß√£o de build/SPA.${NC}"
    fi
fi

echo -e "${GREEN}üöÄ Todas as valida√ß√µes passaram - commit permitido!${NC}"
exit 0